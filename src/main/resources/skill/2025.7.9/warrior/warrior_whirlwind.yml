__option__:
  # 技能名称
  name: "旋风斩"
  # 是否异步执行
  async: false
  # 图标配置
  icon-formatter:
    # 物品材质
    material: GOLDEN_SWORD
    # 显示名称
    name: "旋风斩"
    # 描述信息
    lore:
      - "技能等级 ${ctx skill level}"
      - "技能伤害 ${*damage}"
      - "冷却时间 ${*cooldown}秒"
      - "消耗法力 ${*mp_cost}"
      - "旋转攻击周围所有敌人"
  # 技能分类
  category:
    - "战士"
    - "大技能"
  # 变量定义
  variables:
    # 冷却时间(tick)
    cooldown: 300
    # 伤害计算公式
    damage: 120 + ctx skill level * 25
    # 法力消耗
    mp_cost: 80
    # 攻击半径
    attack_radius: 4.0
    # 旋转次数
    spin_count: 3
    # 技能权重
    skill_weight: 2.0
# 技能脚本
action: |
  fn main() {
    # 检查玩家状态是否允许释放技能
    if sender :: metadataContains("状态", "前摇") || sender :: metadataContains("控制", "沉默") || sender :: metadataContains("状态", "硬直") {
      # 重置冷却时间并退出
      sender :: resetCooldown(skill)
      return
    }
    # 检查法力值是否足够
    if check profile mp < *mp_cost {
      sender :: sendMessage("法力不足！")
      sender :: resetCooldown(skill)
      return
    }
    # 初始化玩家状态
    initPlayerState()
    # 等待前摇时间
    "wait" :: delay("0.3s")
    # 执行旋风斩
    executeWhirlwind()
    # 等待后摇时间
    "wait" :: delay("0.5s")
    # 结束技能效果
    endSkill()
  }
  fn initPlayerState() {
    # 消耗法力值
    profile mp take *mp_cost
    # 设置前摇状态
    sender :: setMetadata("状态", "前摇_旋风斩", 20)
    # 播放技能动画
    "gp model cast ${sender :: name()} warrior_whirlwind_animation" :: executeAsConsole()
    # 播放音效
    "gp sound play ${sender :: name()} warrior_whirlwind_sound player" :: executeAsConsole()
    # 添加缓慢效果
    "effect ${sender :: name()} slow 3 8" :: executeAsConsole()
    # 播放旋风特效
    "gp effect spawn ${sender :: name()} warrior_whirlwind_effect ${sender :: name()}旋风特效 ${sender}" :: executeAsConsole()
  }
  fn executeWhirlwind() {
    # 检查是否仍在前摇状态
    if not sender :: metadataContains("状态", "前摇_旋风斩") {
      return
    }
    # 执行多次旋转攻击
    var spin_counter = 0
    while check &spin_counter < *spin_count {
      # 选择周围的敌人
      var targets = select @circle *attack_radius debug false @their
      # 对目标造成伤害
      ap-attack 技能权重+*skill_weight,斩选择+25 at &targets
      # 播放击中特效
      mythic mob signal WhirlwindImpact at &targets
      # 增加旋转计数
      var spin_counter = &spin_counter + 1
      # 等待下次旋转
      "wait" :: delay("0.4s")
    }
    # 设置后摇状态
    sender :: setMetadata("状态", "后摇_旋风斩", 12)
  }
  fn endSkill() {
    # 移除缓慢效果
    "effect ${sender :: name()} slow 0" :: executeAsConsole()
    # 停止动画
    "gp model stop ${sender :: name()} warrior_whirlwind_animation" :: executeAsConsole()
    # 停止特效
    "gp effect stop ${sender :: name()} warrior_whirlwind_effect" :: executeAsConsole()
  }
