__option__:
  # 技能名称
  name: "背刺"
  # 是否异步执行
  async: false
  # 图标配置
  icon-formatter:
    # 物品材质
    material: IRON_SWORD
    # 显示名称
    name: "背刺"
    # 描述信息
    lore:
      - "技能等级 {{ &level }}"
      - "技能伤害 ${*damage}"
      - "冷却时间 ${*cooldown}秒"
      - "消耗法力 ${*mp_cost}"
      - "从背后攻击敌人造成额外伤害"
  # 技能分类
  category:
    - "刺客"
    - "小技能"
  # 变量定义
  variables:
    # 冷却时间(tick)
    cooldown: 80
    # 伤害计算公式
    damage: 60 + &level * 15
    # 法力消耗
    mp_cost: 25
    # 攻击范围
    attack_range: 2.5
    # 背刺伤害倍数
    backstab_multiplier: 2.5
    # 技能权重
    skill_weight: 1.5
# 技能脚本
action: |
  fn main() {
    # 检查玩家状态是否允许释放技能
    if metadata 状态 contains 前摇 || metadata 控制 contains 沉默 || metadata 状态 contains 硬直 {
      # 重置冷却时间并退出
      sender :: resetCooldown(skill)
      return
    }
    # 检查法力值是否足够
    if sender :: getMagicPoint() < *mp_cost {
      sender :: sendMessage("法力不足！")
      sender :: resetCooldown(skill)
      return
    }
    # 初始化玩家状态
    initPlayerState()
    # 等待前摇时间
    "wait" :: delay("0.2s")
    # 执行背刺
    executeBackstab()
    # 等待后摇时间
    "wait" :: delay("0.3s")
    # 结束技能效果
    endSkill()
  }
  fn initPlayerState() {
    # 消耗法力值
    sender :: takeMagicPoint *mp_cost
    # 设置前摇状态
    sender :: setMetadata("状态", "前摇_背刺", 8)
    # 播放技能动画
    "gp model cast {{ player name }} assassin_backstab_animation" :: executeAsConsole()
    # 播放音效
    "gp sound play {{ player name }} assassin_backstab_sound player" :: executeAsConsole()
    # 向前冲刺
    velocity move "0 0 0.6" at @sender
  }
  fn executeBackstab() {
    # 检查是否仍在前摇状态
    if not metadata 状态 contains 前摇_背刺 {
      return
    }
    # 选择攻击目标
    var targets = select @rectangle 2 2 *attack_range offset "0 0 1" debug false @their
    # 检查是否为背后攻击
    var is_backstab = false
    foreach &targets as target {
      # 计算玩家与目标的相对位置
      var target_yaw = entity &target yaw
      var player_yaw = player yaw
      var angle_diff = abs(&target_yaw - &player_yaw)
      # 如果角度差小于45度,则为背刺
      if &angle_diff < 45 || &angle_diff > 315 {
        var is_backstab = true
      }
    }
    # 根据是否背刺计算伤害
    if &is_backstab is true {
      # 背刺伤害
      ap-attack 技能权重+*skill_weight * *backstab_multiplier,刺选择+25 at &targets
      # 播放背刺特效
      mythic mob signal BackstabCritical at &targets
      # 发送背刺消息
      sender :: sendMessage("成功背刺！造成额外伤害！")
    } else {
      # 普通伤害
      ap-attack 技能权重+*skill_weight,刺选择+15 at &targets
      # 播放普通攻击特效
      mythic mob signal BackstabNormal at &targets
    }
    # 设置后摇状态
    sender :: setMetadata("状态", "后摇_背刺", 8)
  }
  fn endSkill() {
    # 停止动画
    "gp model stop {{ player name }} assassin_backstab_animation" :: executeAsConsole()
  }
