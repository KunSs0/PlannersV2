__option__:
  # 技能名称
  name: "暴风雪"
  # 是否异步执行
  async: false
  # 图标配置
  icon-formatter:
    # 物品材质
    material: SNOWBALL
    # 显示名称
    name: "暴风雪"
    # 描述信息
    lore:
      - "技能等级 ${&level}"
      - "技能伤害 ${*damage}"
      - "冷却时间 ${*cooldown}秒"
      - "消耗法力 ${*mp_cost}"
      - "持续时间 ${*duration}秒"
      - "召唤暴风雪持续攻击范围内的敌人"
  # 技能分类
  category:
    - "法师"
    - "大技能"
    - "冰系"
  # 变量定义
  variables:
    # 冷却时间(tick)
    cooldown: 500
    # 伤害计算公式
    damage: 80 + &level * 20
    # 法力消耗
    mp_cost: 150
    # 射程
    range: 25.0
    # 暴风雪半径
    blizzard_radius: 8.0
    # 持续时间(tick)
    duration: 200
    # 攻击间隔(tick)
    attack_interval: 20
    # 减速等级
    slow_level: 4
    # 技能权重
    skill_weight: 2.5
# 技能脚本
action: |
  fn main() {
    # 检查玩家状态是否允许释放技能
    if sender :: metadataContains("状态", "前摇") || sender :: metadataContains("控制", "沉默") || sender :: metadataContains("状态", "硬直") {
      # 重置冷却时间并退出
      sender :: resetCooldown(skill)
      return
    }
    # 检查法力值是否足够
    if sender :: getMagicPoint() < *mp_cost {
      sender :: sendMessage("法力不足！")
      sender :: resetCooldown(skill)
      return
    }
    # 初始化玩家状态
    initPlayerState()
    # 等待施法时间
    "wait" :: delay("1.5s")
    # 召唤暴风雪
    summonBlizzard()
    # 等待后摇时间
    "wait" :: delay("0.5s")
    # 结束技能效果
    endSkill()
  }
  fn initPlayerState() {
    # 消耗法力值
    sender :: takeMagicPoint(*mp_cost)
    # 设置前摇状态
    sender :: setMetadata("状态", "前摇_暴风雪", 40)
    # 播放施法动画
    "gp model cast ${sender :: name()} mage_blizzard_cast_animation" :: executeAsConsole()
    # 播放施法音效
    "gp sound play ${sender :: name()} mage_blizzard_cast_sound player" :: executeAsConsole()
    # 播放施法特效
    "gp effect spawn ${sender :: name()} mage_blizzard_cast_effect ${sender :: name()}暴风雪施法特效 ${sender}" :: executeAsConsole()
    # 添加缓慢效果防止移动
    "effect ${sender :: name()} slow 8 6" :: executeAsConsole()
    # 发送提示消息
    sender :: sendMessage("正在召唤暴风雪...")
  }
  fn summonBlizzard() {
    # 检查是否仍在前摇状态
    if !sender :: metadataContains("状态", "前摇_暴风雪") {
      return
    }
    # 获取目标位置
    var target_location = sender :: lookLocation(*range)
    # 播放暴风雪开始音效
    "gp sound play ${sender :: name()} mage_blizzard_start_sound player" :: executeAsConsole()
    # 播放暴风雪特效
    "gp effect spawn ${sender :: name()} mage_blizzard_effect 暴风雪特效 ${&target_location}" :: executeAsConsole()
    # 开始暴风雪循环攻击
    blizzardLoop(&target_location)
  }
  fn blizzardLoop(&target_location) {
    # 计算攻击次数
    var attack_count = *duration / *attack_interval
    var current_attack = 0
    # 循环攻击
    while &current_attack < &attack_count {
      # 选择暴风雪范围内的敌人
      var targets = select @circle *blizzard_radius at &target_location debug false @their
      # 对目标造成伤害
      ap-attack 技能权重+*skill_weight,冰选择+20 at &targets
      # 对目标施加减速效果
      "effect ${&targets} slowness *attack_interval *slow_level" :: executeAsConsole()
      # 对目标施加冰冻状态
      &targets :: setMetadata("状态", "冰冻", *attack_interval)
      # 播放冰雪攻击特效
      mythic mob signal BlizzardAttack at &targets
      # 增加攻击计数
      current_attack = &current_attack + 1
      # 等待下次攻击
      "wait" :: delayTicks(*attack_interval)
    }
    # 设置后摇状态
    sender :: setMetadata("状态", "后摇_暴风雪", 12)
  }
  fn endSkill() {
    # 移除缓慢效果
    "effect ${sender :: name()} slow 0" :: executeAsConsole()
    # 停止施法动画
    "gp model stop ${sender :: name()} mage_blizzard_cast_animation" :: executeAsConsole()
    # 停止施法特效
    "gp effect stop ${sender :: name()} mage_blizzard_cast_effect" :: executeAsConsole()
    # 停止暴风雪特效
    "gp effect stop ${sender :: name()} mage_blizzard_effect" :: executeAsConsole()
  }
