__option__:
  # 技能名称
  name: "法力护盾"
  # 是否异步执行
  async: false
  # 图标配置
  icon-formatter:
    # 物品材质
    material: BARRIER
    # 显示名称
    name: "法力护盾"
    # 描述信息
    lore:
      - "技能等级 ${ctx skill level}"
      - "护盾吸收伤害 ${*shield_absorption}"
      - "法力转换比例 ${*mana_ratio}:1"
      - "被动技能：用法力值吸收伤害"
  # 技能分类
  category:
    - "法师"
    - "被动技能"
  # 变量定义
  variables:
    # 护盾吸收伤害百分比
    shield_absorption: 20 + ctx skill level * 5
    # 法力转换比例(法力:伤害)
    mana_ratio: 2 - ctx skill level * 0.1
    # 属性持续时间(永久)
    duration: -1
# 技能脚本
action: |
  fn main() {
    # 被动技能在学习时自动激活
    activatePassive()
    # 注册受伤事件监听器
    registerDamageListener()
  }
  fn activatePassive() {
    # 发送激活消息
    sender :: sendMessage("法力护盾被动技能已激活！")
  }
  fn registerDamageListener() {
    # 监听受到伤害事件
    var damage_listener = listen handleDamageReceived on damaged priority HIGH
    # 保存监听器引用
    sender :: setMetadata("法力护盾监听器", &damage_listener, -1)
  }
  fn handleDamageReceived() {
    # 获取受到的伤害
    var damage_amount = event damage
    # 计算护盾吸收的伤害
    var absorbed_damage = &damage_amount * *shield_absorption / 100
    # 计算需要消耗的法力值
    var mana_cost = &absorbed_damage * *mana_ratio
    # 检查法力值是否足够
    if sender :: getMagicPoint() >= &mana_cost {
      # 消耗法力值
      sender :: takeMagicPoint(&mana_cost)
      # 减少受到的伤害
      var new_damage = &damage_amount - &absorbed_damage
      event damage to &new_damage
      # 播放护盾特效
      "gp effect spawn ${sender :: name()} mage_mana_shield_effect 法力护盾特效 ${sender}" :: executeAsConsole()
      # 播放护盾音效
      "gp sound play ${sender :: name()} mage_mana_shield_sound player" :: executeAsConsole()
      # 发送提示消息
      sender :: sendMessage("法力护盾吸收了 ${&absorbed_damage} 点伤害！")
    }
  }
  fn deactivatePassive() {
    # 停止监听器
    var listener = sender :: getMetadata("法力护盾监听器")
    if &listener is not null {
      unlisten &listener
    }
    # 发送停用消息
    sender :: sendMessage("法力护盾被动技能已停用。")
  }
